# Release Workflow
# Triggered when a new release is published on GitHub
# Creates:
#   - GitHub Release with binaries
#   - .deb, .rpm, .apk packages
#   - Docker images (multi-arch)
#   - Checksums

name: Release

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Required for changelog generation

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: dist/*
          retention-days: 30

  # Notify about successful release (optional)
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: release
    if: success()
    
    steps:
      - name: Get release info
        id: release_info
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          
      - name: Create summary
        run: |
          echo "## ðŸŽ‰ Release ${{ steps.release_info.outputs.tag }} published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Downloads available:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Linux**: .deb, .rpm, .apk, binary" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ **macOS**: binary (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªŸ **Windows**: .exe" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ **Docker**: \`ghcr.io/lan-dot-party/flowgauge:${{ steps.release_info.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Debian/Ubuntu" >> $GITHUB_STEP_SUMMARY
          echo "wget https://github.com/lan-dot-party/flowgauge/releases/download/${{ steps.release_info.outputs.tag }}/flowgauge_*_linux_amd64.deb" >> $GITHUB_STEP_SUMMARY
          echo "sudo dpkg -i flowgauge_*.deb" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# RHEL/Fedora" >> $GITHUB_STEP_SUMMARY
          echo "sudo rpm -i https://github.com/lan-dot-party/flowgauge/releases/download/${{ steps.release_info.outputs.tag }}/flowgauge_*_linux_amd64.rpm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Alpine" >> $GITHUB_STEP_SUMMARY
          echo "wget https://github.com/lan-dot-party/flowgauge/releases/download/${{ steps.release_info.outputs.tag }}/flowgauge_*_linux_amd64.apk" >> $GITHUB_STEP_SUMMARY
          echo "sudo apk add --allow-untrusted flowgauge_*.apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Docker" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/lan-dot-party/flowgauge:${{ steps.release_info.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY


